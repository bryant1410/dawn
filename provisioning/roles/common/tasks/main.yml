---
- include: docker.yml

#- name: destroy old instances
#  shell: docker stop $(docker ps -a -q) && docker rm $(docker ps -a -q)

- name: spin up redis-hipache
  command: docker run -d -p 6379:6379 --name redis-hipache shipyard/redis

- name: spin up hipache
  command: docker run -d -p 80:80 --name hipache --link redis-hipache:redis shipyard/router

- name: spin up postgres
  command: docker run -d -p 5432:5432 -e POSTGRESQL_USER=dawn -e POSTGRESQL_PASS=dawn --name postgres orchardup/postgresql

- name: spin up redis-logplex
  command: docker run -d -p 6733:6379 --name redis-logplex shipyard/redis

- name: spin up logplex
  command: docker run -d -p 8001:8001 -p 8601:8601 --name logplex -h logplex --link redis-logplex:redis dawn/logplex

- name: build dawn/buildstep
  command: docker build -t dawn/buildstep . chdir={{ app_path }}/services/buildstep

- name: build dawn/dawn
  command: docker build -t dawn/dawn . chdir={{ app_path }}

- name: setup the database
  command: docker run --rm --link redis-hipache:redis-hipache --link redis-logplex:redis-logplex --link postgres:postgres dawn/dawn bin/rake db:create db:migrate db:seed

- name: setup logplex
  command: docker run --rm --link redis-hipache:redis-hipache --link redis-logplex:redis-logplex --link postgres:postgres dawn/dawn script/logplex

- name: deploy API
  command: docker run -p 5000:5000 --name api --link redis-hipache:redis-hipache --link redis-logplex:redis-logplex --link postgres:postgres --link logplex:logplex dawn/dawn

- name: generate ssh key for gitreceived
  command: ssh-keygen -t rsa -N "" -f git.key chdir={{ app_path }}/gitreceived creates={{ app_path }}/gitreceived/git.key

- name: spin up gitreceived
  shell: docker run -d -p 2201:2201 --name gitreceived --link api:api -v=/var/run/docker.sock:/var/run/docker.sock -e SSH_PRIVATE_KEYS="$(cat {{ app_path }}/git.key)" dawn/gitreceive

