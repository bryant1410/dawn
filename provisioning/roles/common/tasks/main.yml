---
- name: create dawn user
  tags: user
  user: name={{ user_main }}
        shell=/bin/bash
        state=present
        uid=453
        groups="docker"

- name: create /var/log/dawn for Upstart
  sudo: yes
  file: path=/var/log/dawn
        owner={{ user_main }}
        state=directory

- name: install userspace packages
  apt: update_cache=yes pkg={{ item }} state=present
  tags: [packages]
  with_items:
    - curl
    - git
    - python-pycurl # needed for apt_repo

- include: ruby.yml
- include: docker.yml

- name: spin up redis-hipache
  command: docker run -d -p 6379:6379 --name redis-hipache shipyard/redis

- name: spin up hipache
  command: docker run -d -p 80:80 --name hipache --link redis-hipache:redis shipyard/router

- name: spin up postgres
  command: docker run -d -p 5432:5432 -e POSTGRESQL_USER=dawn -e POSTGRESQL_PASS=dawn --name postgres orchardup/postgresql

- name: spin up redis-logplex
  command: docker run -d -p 6733:6379 --name redis-logplex shipyard/redis

- name: spin up logplex
  command: docker run -d -p 8001:8001 -p 8601:8601 --name logplex -h logplex --link redis-logplex:redis dawn/logplex
